// Generated by CoffeeScript 1.3.3
(function() {
  var Items, canonicalListName, itemMapping, listModel, newListModel, nextSiblingnIdx, reset_data, samples, viewModel, vm;

  Items = new Meteor.Collection('items');

  samples = (typeof exports !== "undefined" && exports !== null ? exports : this).samples || [];

  reset_data = function() {
    var i, newid, sample, _i, _len;
    Items.remove({
      list: (typeof vm.listName === "function" ? vm.listName() : void 0) || 'Sample'
    });
    for (i = _i = 0, _len = samples.length; _i < _len; i = ++_i) {
      sample = samples[i];
      newid = Items.insert({
        item: sample.item,
        archived: sample.archived,
        list: (typeof vm.listName === "function" ? vm.listName() : void 0) || 'Shopping-List',
        idx: sample.idx
      });
    }
  };

  if (Meteor.is_client) {
    itemMapping = {
      item: {
        create: function(options) {
          var itemObject, observable;
          itemObject = options.parent;
          observable = ko.observable(options.data);
          itemObject.isMoving = ko.observable(false);
          itemObject.indent = ko.observable(typeof this.idx === "function" ? this.idx().split('.').length : void 0);
          itemObject.canMoveHere = ko.computed(function() {
            return vm.vm().isMoving() && !this.isMoving();
          }, itemObject);
          itemObject.doIndent = function() {
            var descendents, itm, _i, _len;
            descendents = itemObject.getDescendents();
            itemObject.indent(itemObject.indent() + 1);
            for (_i = 0, _len = descendents.length; _i < _len; _i++) {
              itm = descendents[_i];
              itm.indent(itm.indent() + 1);
            }
            vm.vm().saveAll();
          };
          itemObject.doOutdent = function() {
            var descendents, itm, _i, _len;
            descendents = itemObject.getDescendents();
            itemObject.indent(itemObject.indent() - 1);
            for (_i = 0, _len = descendents.length; _i < _len; _i++) {
              itm = descendents[_i];
              itm.indent(itm.indent() - 1);
            }
            vm.vm().saveAll();
          };
          itemObject.getDescendents = function() {
            var itemsAfter, itm, _i, _len;
            itemsAfter = vm.vm().items().slice(vm.vm().items.indexOf(itemObject) + 1);
            for (_i = 0, _len = itemsAfter.length; _i < _len; _i++) {
              itm = itemsAfter[_i];
              if (itm.indent() <= itemObject.indent()) {
                break;
              }
              return itm;
            }
          };
          itemObject.save = function() {
            return Items.update(itemObject._id(), {
              $set: {
                item: itemObject.item()
              }
            });
          };
          itemObject.unarchive = function() {
            var descendents, itm, _i, _len;
            descendents = itemObject.getDescendents();
            itemObject.archived(false);
            for (_i = 0, _len = descendents.length; _i < _len; _i++) {
              itm = descendents[_i];
              itm.archived(false);
            }
            return vm.vm().saveAll();
          };
          itemObject.remove = function() {
            var descendents, itm, _i, _j, _len, _len1, _results;
            descendents = itemObject.getDescendents();
            if (itemObject.archived()) {
              Items.remove(itemObject._id());
              _results = [];
              for (_i = 0, _len = descendents.length; _i < _len; _i++) {
                itm = descendents[_i];
                _results.push(Items.remove(itm._id()));
              }
              return _results;
            } else {
              itemObject.archived(true);
              for (_j = 0, _len1 = descendents.length; _j < _len1; _j++) {
                itm = descendents[_j];
                itm.archived(true);
              }
              return vm.vm().saveAll();
            }
          };
          return observable;
        }
      }
    };
    newListModel = function(parent) {
      var _this = this;
      this.name = ko.observable('');
      this.saveOnEnter = function(model, event) {
        if (event.which !== 13) {
          return true;
        }
        model.save();
        return false;
      };
      this.goShopping = function() {
        window.location.href = 'http://' + window.location.host + '/#!Shopping-List';
        window.location.reload();
      };
      this.save = function() {
        Session.set('listName', canonicalListName(_this.name()));
        window.location.href = 'http://' + window.location.host + '/#!' + canonicalListName(_this.name());
        window.location.reload();
      };
    };
    listModel = function(parent) {
      var actionSetTemplate, actionSets, checkKeydownBindings, createNewItem, focusNextOnDown, focusPreviousOnUp, indentOn3Spaces, isMoving, items, itemsToMoveCount, itemsToMoveIndex, moveHere, moveItem, outdentOnBackspaceAndEmpty, prevItem, rotateActionSets, saveAll, saveOnEnter, _this;
      _this = this;
      items = ko.meteor.find(Items, {
        list: parent.listName()
      }, {
        sort: {
          idx: 1
        }
      }, itemMapping);
      isMoving = ko.observable(false);
      itemsToMoveIndex = ko.observable();
      itemsToMoveCount = ko.observable();
      actionSets = ko.observableArray(['archiveRemove', 'indentOutdent']);
      prevItem = function(model) {
        return items()[items.indexOf(model) - 1];
      };
      saveAll = function() {
        var ancestorFound, ancestorItem, curIdx, i, itm, _i, _j, _len, _len1, _ref;
        curIdx = "001";
        for (i = _i = 0, _len = items.length; _i < _len; i = ++_i) {
          itm = items[i];
          if (itm.indent() > (prevItem != null ? prevItem.indent() : void 0)) {
            curIdx = curIdx + ".001";
          }
          if (itm.indent() === (prevItem != null ? prevItem.indent() : void 0)) {
            curIdx = nextSiblingnIdx(curIdx);
          }
          if (itm.indent() < (prevItem != null ? prevItem.indent() : void 0)) {
            ancestorFound = false;
            _ref = items().slice(0, (i - 1) + 1 || 9e9).reverse();
            for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
              ancestorItem = _ref[_j];
              if (ancestorItem.indent() === itm.indent()) {
                curIdx = nextSiblingnIdx(ancestorItem.idx());
                ancestorFound = true;
                break;
              }
            }
          }
          Items.update(itm._id(), {
            $set: {
              item: itm.item(),
              archived: itm.archived(),
              idx: curIdx
            }
          });
          prevItem = itm;
        }
      };
      createNewItem = function() {
        var lastIdx, newid;
        lastIdx = items()[items().length].idx();
        newid = Items.insert({
          item: '',
          archived: false,
          list: vm.listName(),
          idx: nextSiblingnIdx(lastIdx)
        });
        return Meteor.defer(function() {
          return $("." + newid + " input")[0].focus();
        });
      };
      indentOn3Spaces = function(model, event) {
        var myId;
        if (event.which !== 32) {
          return;
        }
        if (model.item().substr(0, 2) !== '  ') {
          return;
        }
        model.item(model.item().substring(2));
        model.doIndent();
        myId = model._id();
        return Meteor.defer(function() {
          return $("." + myId + " input")[0].focus();
        });
      };
      outdentOnBackspaceAndEmpty = function(model, event) {
        var focusid, myId, _ref;
        if (event.which !== 8) {
          return;
        }
        if (model.item() !== '') {
          return;
        }
        model.save();
        if (!model.parent()) {
          focusid = model._id();
          if (model.archived()) {
            focusid = (_ref = items()[items.indexOf(model) - 1]) != null ? _ref._id() : void 0;
          }
          model.remove();
          return Meteor.defer(function() {
            return $("." + focusid + " input").each(function() {
              return $(this).focus();
            });
          });
        } else {
          model.doOutdent();
          myId = model._id();
          return Meteor.defer(function() {
            return $("." + myId + " input")[0].focus();
          });
        }
      };
      checkKeydownBindings = function(model, event) {
        indentOn3Spaces(model, event);
        outdentOnBackspaceAndEmpty(model, event);
        saveOnEnter(model, event);
        focusPreviousOnUp(model, event);
        focusNextOnDown(model, event);
        return true;
      };
      focusPreviousOnUp = function(model, event) {
        var prevId, _ref;
        if (event.which !== 38) {
          return;
        }
        prevId = (_ref = items()[items.indexOf(model) - 1]) != null ? _ref._id() : void 0;
        model.save();
        if (prevId) {
          return Meteor.defer(function() {
            return $("." + prevId + " input")[0].focus();
          });
        }
      };
      focusNextOnDown = function(model, event) {
        var nextId, _ref;
        if (event.which !== 40) {
          return;
        }
        nextId = (_ref = items()[items.indexOf(model) + 1]) != null ? _ref._id() : void 0;
        model.save();
        if (nextId) {
          return Meteor.defer(function() {
            return $("." + nextId + " input")[0].focus();
          });
        }
      };
      saveOnEnter = function(model, event) {
        var newid;
        if (event.which !== 13) {
          return true;
        }
        model.save();
        newid = Items.insert({
          item: '',
          archived: false,
          list: vm.listName(),
          idx: nextSiblingnIdx(model.idx())
        });
        Meteor.defer(function() {
          return $("." + newid + " input")[0].focus();
        });
        return false;
      };
      moveItem = function(data) {
        var countOfItems, itm, pos, _i, _len, _ref;
        itemsToMoveIndex(items.indexOf(data));
        data.isMoving(true);
        pos = items.indexOf(data);
        countOfItems = 1;
        _ref = items.slice(pos + 1);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          itm = _ref[_i];
          if (itm.indent() <= data.indent()) {
            break;
          }
          countOfItems++;
          itm.isMoving(true);
        }
        isMoving(true);
        return itemsToMoveCount(countOfItems);
      };
      moveHere = function(data) {
        var cutItems, i, id, itm, pastePos, rootItemOldIndent, rootItemToMove, tail, _i, _j, _k, _l, _len, _len1, _len2, _len3, _len4, _m, _ref, _ref1, _ref2;
        cutItems = items.splice(itemsToMoveIndex(), itemsToMoveCount());
        rootItemToMove = cutItems[0];
        rootItemOldIndent = rootItemToMove.indent();
        rootItemToMove.ancestors(data.ancestors().slice(0));
        rootItemToMove.ancestors.push(data._id());
        rootItemToMove.parent(data.parent());
        _ref = cutItems.slice(1);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          itm = _ref[_i];
          itm.ancestors.splice(0, rootItemOldIndent);
          _ref1 = rootItemToMove.ancestors.slice(0).reverse();
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            id = _ref1[_j];
            itm.ancestors.unshift(id);
          }
        }
        pastePos = items.indexOf(data) + 1;
        tail = items.splice(pastePos, 9e9);
        for (_k = 0, _len2 = cutItems.length; _k < _len2; _k++) {
          itm = cutItems[_k];
          items.push(itm);
        }
        for (_l = 0, _len3 = tail.length; _l < _len3; _l++) {
          itm = tail[_l];
          items.push(itm);
        }
        isMoving(false);
        _ref2 = items();
        for (i = _m = 0, _len4 = _ref2.length; _m < _len4; i = ++_m) {
          itm = _ref2[i];
          Items.update(itm._id(), {
            $set: {
              sortOrder: i,
              parent: itm.parent(),
              ancestors: itm.ancestors()
            }
          });
          itm.isMoving(false);
          prevItem = itm;
        }
      };
      rotateActionSets = function() {
        return actionSets.push(actionSets.shift());
      };
      actionSetTemplate = ko.computed(function() {
        return actionSets()[0] + 'Template';
      });
      return {
        items: items,
        createNewItem: createNewItem,
        checkKeydownBindings: checkKeydownBindings,
        saveOnEnter: saveOnEnter,
        moveItem: moveItem,
        isMoving: isMoving,
        moveHere: moveHere,
        actionSetTemplate: actionSetTemplate,
        rotateActionSets: rotateActionSets
      };
    };
    viewModel = function() {
      var _this = this;
      this.listName = ko.observable(canonicalListName(Session.get('listName')));
      this.showingJSON = ko.observable(false);
      this.json = ko.observable('');
      this.templateToUse = function() {
        if (_this.listName()) {
          return 'socialist';
        } else {
          return 'newList';
        }
      };
      this.vm = ko.observable(this.listName() === '' ? new newListModel(this) : new listModel(this));
      this.listName.subscribe(function() {
        if (_this.listName() === '') {
          return _this.vm(new newListModel(_this));
        } else {
          return _this.vm(new listModel(_this));
        }
      });
      this.resetData = function() {
        return reset_data();
      };
      this.showJSON = function() {
        if (_this.vm().items) {
          _this.json(ko.mapping.toJSON(_this.vm().items));
        }
        return _this.showingJSON(true);
      };
      this.newList = function() {
        Session.set('listName', '');
        return true;
      };
      this.delArchived = function() {
        return Items.remove({
          list: this.listName(),
          archived: true
        });
      };
      this.archiveAll = function() {
        if (_this.vm().items) {
          Items.update({
            list: vm.listName
          }, {
            $set: {
              archived: true
            }
          }, {
            multi: true
          });
        }
      };
    };
    canonicalListName = function(name) {
      return name.replace(/[^-A-z0-9\s]*/g, '').replace(/\s+/g, '-');
    };
    nextSiblingnIdx = function(idx) {
      return idx.replace(/\d{3}$/, ("000" + (parseInt(idx.match(/\d{3}$/)) + 1)).slice(-3));
    };
    Session.set('listName', window.location.hash.replace('#!', '') || '');
    vm = new viewModel();
    Meteor.startup(function() {
      return ko.applyBindings(vm);
    });
  }

  if (Meteor.is_server) {
    Meteor.methods({
      indent: function(idx, prevIdx) {
        var itemWithChildren, itm, startsWithIdx, _i, _len, _results;
        startsWithIdx = new RegExp("^" + (idx.replace('.', '\\.')) + ".*", "i");
        itemWithChildren = Items.find({
          idx: startsWithIdx
        });
        _results = [];
        for (_i = 0, _len = itemWithChildren.length; _i < _len; _i++) {
          itm = itemWithChildren[_i];
          _results.push(Items.update(itm._id, {
            $set: {
              idx: itm.idx.replace(startsWithIdx, prevIdx + '.001')
            }
          }, {
            multi: true
          }));
        }
        return _results;
      }
    });
    Meteor.startup(function() {
      if (Items.find().count() === 0) {
        return reset_data();
      }
    });
  }

}).call(this);
